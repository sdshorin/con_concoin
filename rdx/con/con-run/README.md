# Con-Run: Учебный проект узла децентрализованного блокчейна

Простая реализация узла децентрализованного блокчейна с использованием Gossip протокола и PEX (Peer Exchange) для учебных целей.

## Особенности

- Реализация на Go
- Gossip протокол для распространения сообщений
- PEX протокол для обмена пирами
- Локальное хранение данных в файловой системе (JSON)
- Дебаг-API для мониторинга состояния узла
- Сетевая статистика для мониторинга всей сети

## Требования

- Go 1.21+

## Установка

1. Клонировать репозиторий:

2. Установить зависимости:
   ```
   go mod download
   ```

3. Собрать проект:
   ```
   go build -o bin/node cmd/node/main.go
   ```

## Запуск

### Запуск одиночного узла

```
./bin/node --port=3000
```

### Запуск узла с подключением к seed-узлу

```
./bin/node --port=3001 --seed=3000
```

### Запуск с чистым стартом (удаление всех данных)

```
./bin/node --port=3000 --clean
```

### Запуск тестовой сети

Для Linux/Unix:
```
cd scripts
chmod +x run_nodes.sh
./run_nodes.sh
```

Для MacOS:
```
cd scripts
chmod +x run_nodes_mac.sh
./run_nodes_mac.sh
```

### Отправка сообщений в сеть
```
cd scripts
chmod +x run_nodes.sh
./send_test_messages.py
```

## Холодный старт

При первом запуске или после очистки данных (флаг `--clean`), узел выполняет следующие действия:

1. Создает необходимые директории для хранения данных
2. Инициализирует конфигурацию узла
3. Подключается к seed-узлам (если указаны)
4. Начинает обмен пирами через PEX протокол
5. Синхронизирует сообщения с подключенными пирами

## Хранение данных

### Сообщения

Сообщения хранятся в директории `.nodedata/port<port>/messages/` в формате JSON. Каждое сообщение сохраняется в отдельный файл с именем `<message_id>.json`. Сообщения содержат:
- ID сообщения
- ID отправителя
- Временную метку
- TTL (время жизни)
- Тип сообщения
- Полезную нагрузку

### Пиры

Информация о пирах хранится в директории `.nodedata/port<port>/peers/` в формате JSON. Каждый пир сохраняется в отдельный файл с именем `<node_id>.json`. Для каждого пира хранится:
- ID узла
- Адрес
- Время последнего обращения

### Конфигурация

Конфигурация узла хранится в файле `.nodedata/port<port>/config/config.json` и содержит:
- ID узла
- Порт
- Seed-узлы
- Параметры Gossip протокола
- Параметры PEX протокола

## Структура проекта

```
.
├── cmd/
│   └── node/           # Точка входа приложения
├── pkg/
│   ├── api/           # HTTP API и веб-интерфейс
│   ├── blockchain/    # Заглушка блокчейна
│   ├── config/        # Конфигурация
│   ├── gossip/        # Gossip протокол
│   ├── models/        # Модели данных
│   ├── pex/           # PEX протокол
│   └── storage/       # Хранение данных
└── scripts/           # Скрипты для запуска тестовой сети
```

## API

### Дебаг интерфейс

```
http://localhost:<port>/debug
```

Отображает:
- Статистику узла
- Высоту блокчейна
- Количество подключенных пиров
- Логи работы узла

### Сетевая статистика

```
http://localhost:<port>/network
```

Отображает:
- Информацию о локальном узле
- Список всех известных пиров
- Статус подключения каждого пира
- Ссылки на дебаг-интерфейсы других узлов

### API узла


#### Получение списка сообщений
```
GET http://localhost:<port>/messages
```

#### Получение конкретного сообщения
```
GET http://localhost:<port>/messages/<message_id>
```

#### Добавление нового сообщения
```
POST http://localhost:<port>/add_message
Content-Type: application/json

{
    "payload": "New message"
}
```

