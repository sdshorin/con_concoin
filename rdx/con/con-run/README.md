# Con-Run: Учебный проект узла децентрализованного блокчейна

Простая реализация узла децентрализованного блокчейна с использованием Gossip протокола и PEX (Peer Exchange) для учебных целей.

## Особенности

- Реализация на Go
- Gossip протокол для распространения сообщений
- PEX протокол для обмена пирами
- Локальное хранение данных в файловой системе (JSON)
- Дебаг-API для мониторинга состояния узла
- Сетевая статистика для мониторинга всей сети

## Примеры работы

![Отладочная информация узла](img/node_debug.png)
![Сетевая статистика](img/node_network.png)
![Пример запуска](img/run_example.png)

## Требования

- Go 1.21+

## Установка

1. Клонировать репозиторий:

2. Установить зависимости:
   ```
   go mod download
   ```

3. Собрать проект:
   ```
   go build -o bin/node cmd/node/main.go
   ```

## Запуск

### Запуск одиночного узла

```
./bin/node --port=3000
```

### Запуск узла с подключением к seed-узлу

```
./bin/node --port=3001 --seed=3000
```

### Запуск с чистым стартом (удаление всех данных)

```
./bin/node --port=3000 --clean
```

### Подготовка скриптов
```
cd scripts
chmod +x run_nodes.sh
chmod +x run_nodes_mac.sh
chmod +x add_nodes_mac.sh
chmod +x send_test_messages.py
chmod +x send_blockchain_messages.py
```

### Запуск тестовой сети

Для Linux/Unix:
```
./run_nodes.sh
```

Для MacOS:
```
./run_nodes_mac.sh
```

### Добавление новых узлов

Для MacOS:
```
./add_nodes_mac.sh
```

### Отправка сообщений в сеть
```
./send_test_messages.py
```
или

```
./send_blockchain_messages.py
```

## Система хуков


## Холодный старт

При первом запуске или после очистки данных (флаг `--clean`), узел выполняет следующие действия:

1. Создает необходимые директории для хранения данных
2. Инициализирует конфигурацию узла
3. Подключается к seed-узлам (если указаны)
4. Начинает обмен пирами через PEX протокол
5. Синхронизирует сообщения с подключенными пирами (запрашивает у пиров список сообщений и скачивает сообщения, которые у него отсутствуют)

## Хранение данных

### Сообщения

Сообщения хранятся в директории `.nodedata/port<port>/messages/` в формате JSON. Каждое сообщение сохраняется в отдельный файл с именем `<message_id>.json`. Сообщения содержат:
- ID сообщения
- ID отправителя
- Временную метку
- TTL (время жизни)
- Тип сообщения
- Полезную нагрузку

### Пиры

Информация о пирах хранится в директории `.nodedata/port<port>/peers/` в формате JSON. Каждый пир сохраняется в отдельный файл с именем `<node_id>.json`. Для каждого пира хранится:
- ID узла
- Адрес
- Время последнего обращения

### Конфигурация

Конфигурация узла хранится в файле `.nodedata/port<port>/config/config.json` и содержит:
- ID узла
- Порт
- Seed-узлы
- Параметры Gossip протокола
- Параметры PEX протокола

## Структура проекта

```
.
├── cmd/
│   └── node/                  # Точка входа приложения
├── pkg/
│   ├── api/                   # HTTP API и веб-интерфейс
│   ├── config/                # Конфигурация
│   ├── gossip/                # Gossip протокол
│   ├── hooks/                 # Система хуков для обработки входящих сообщений
│       └── blockchain_tools/  # Хуки для системы блокчейна (sh-заглушки)
│   ├── interfaces             # Интерфайсы
│   ├── models/                # Модели данных
│   ├── pex/                   # PEX протокол
│   └── storage/               # Хранение данных
└── scripts/                   # Скрипты для запуска тестовой сети
```

## API

### Дебаг интерфейс

```
http://localhost:<port>/debug
```

Отображает:
- Статистику узла
- Количество подключенных пиров
- Логи работы узла
- Все сообщения на узле

### Сетевая статистика

```
http://localhost:<port>/network
```

Отображает:
- Информацию о локальном узле
- Список всех известных пиров
- Статус подключения каждого пира
- Ссылки на дебаг-интерфейсы других узлов

### API узла


#### Получение списка сообщений
```
GET http://localhost:<port>/messages
```

#### Получение конкретного сообщения
```
GET http://localhost:<port>/messages/<message_id>
```

#### Добавление нового сообщения сторонним пользователем
```
POST http://localhost:<port>/add_message
Content-Type: application/json

{
   "type": "user_message",
   "payload": {"text": "New message"}
}
```

